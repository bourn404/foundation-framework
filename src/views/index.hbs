<!DOCTYPE html>
<html>
    <head>
        {{>head}}
        <script src="/js/app.js"></script>

    </head>
    <body>
        {{>header}}
        <div id="actions">
            <p>Click "Check In" to begin receiving calls.</p>
            <button onclick="checkIn()">Check In</button>
        </div>
        <!-- <button onclick="answer(calls[0])">Answer</button> -->
        {{>footer}}

        <script src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="/js/twilio.min.js"></script>
        <script type="text/javascript" src="/js/axios.min.js"></script>
        
        <script>
            let calls = [];
            let clientIdentity = "";

            const socket = io();
            socket.on('callComing',(data)=>{
                console.log(data);
                calls[0]=data;
                if(confirm('Call incoming.  Click ok to answer.')) {
                    answer(calls[0]);
                }
            })

            Twilio.Device.on('incoming',(conn)=>{
                console.log('Incoming connection from ' + conn.parameters.From);
                conn.accept();
            })

            function answer(call) {
                axios.post('/voice/answer',{id:call.data.CallSid, clientIdentity: clientIdentity});
            }

            function checkIn() {
                axios.get('/voice/token')
                .then((resp)=>{
                    Twilio.Device.setup(resp.data.token);
                    clientIdentity = resp.data.clientIdentity;
                    document.getElementById('actions').innerHTML = 'You are checked in. Call 385-343-4563';
                })
            }
        </script>



    </body>

</html>